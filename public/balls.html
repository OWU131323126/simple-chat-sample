<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å‚¾ã‘ã¦è»¢ãŒã™ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹ (å›ºå®šã‚«ãƒ¡ãƒ©)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <style>
      /* å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¶­æŒ */
      body {
        margin: 0;
        padding: 20px;
        font-family: sans-serif;
      }
      canvas {
        display: block;
        margin-top: 20px;
        border: 1px solid #ccc;
      }
      #status-info {
        margin-top: 10px;
        font-size: 1.1em;
      }
    </style>
  </head>

  <body>
    <h1>ã‚¹ãƒãƒ›ã‹ã‚‰ã®ã‚»ãƒ³ã‚µæƒ…å ±ã‚’å—ä¿¡</h1>
    <div>
      <div>ã‚ãªãŸã®ID: <span id="myid"></span></div>
      <button id="connect">ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
      <div>å—ä¿¡ã—ãŸæƒ…å ±ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã§ç¢ºèªã—ã¦ãã ã•ã„</div>
      <div id="status-info">
        **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ: <span id="checkpoint-count">0</span> / 5**
        <br>
        **ã‚¿ã‚¤ãƒ : <span id="gameTime">0.000</span>s**
      </div>
      <div id="message" style="color: red; font-weight: bold;"></div>
    </div>
    <script>
      let socket = io.connect();

      let btn = document.querySelector("#connect");
      let b = 0; // beta (ãƒ”ãƒƒãƒè§’)
      let g = 0; // gamma (ãƒ­ãƒ¼ãƒ«è§’)

      let myid = sessionStorage.getItem('clientId');
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem('clientId', myid);
      }
      
      document.querySelector("#myid").innerHTML = myid;
      console.log("ã‚ãªãŸã®ID: ", myid);

      btn.addEventListener("click", function () {
        socket.emit("join", "game");
        btn.remove();
        document.querySelector("#message").innerHTML = "ğŸ® **ãƒ¬ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ¼ãƒˆï¼** æœ€åˆã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ç›®æŒ‡ã›ï¼";
        startGame();
      });
    
      socket.on("sensor", function (data) {
        g = parseFloat(data.g);
        b = parseFloat(data.b);
        console.log(data); // å…ƒã®ã‚³ãƒ¼ãƒ‰ã®é€šã‚Šã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«å‡ºåŠ›
      });

      // --- Game Variables ---
      let x = 0; // ãƒœãƒ¼ãƒ«Xåº§æ¨™
      let y = 0; // ãƒœãƒ¼ãƒ«Yåº§æ¨™
      let r = 40; // ãƒœãƒ¼ãƒ«åŠå¾„
      let speed = 0.3; // ãƒœãƒ¼ãƒ«é€Ÿåº¦èª¿æ•´
      let plate_size = 800; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º/æ¿ã®ã‚µã‚¤ã‚º
      
      let checkpoints = []; // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåº§æ¨™ã®é…åˆ—
      let currentCheckpoint = 0; // ç¾åœ¨ç›®æŒ‡ã™ã¹ããƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      let target_radius = 50; // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®åŠå¾„
      
      let barriers = []; // éšœå®³ç‰©åº§æ¨™ã®é…åˆ—

      let is_playing = false;
      let startTime = 0;
      let elapsedTime = 0;
      
      function setupBarriers() {
          // 3ã¤ã®ãƒ©ãƒ³ãƒ€ãƒ ãªéšœå®³ç‰©ï¼ˆæŸ±ï¼‰ã‚’è¨­å®š
          barriers = [];
          const half_size = (plate_size / 2) - 100;
          for (let i = 0; i < 3; i++) {
              barriers.push({
                  x: random(-half_size, half_size),
                  y: random(-half_size, half_size)
              });
          }
      }

      function setupCheckpoints() {
        // 5ã¤ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š (ç”»é¢ä¸­å¤®ä»˜è¿‘ã‚’é¿ã‘ã‚‹)
        checkpoints = [];
        const half_size = (plate_size / 2) - 150;
        for (let i = 0; i < 5; i++) {
            checkpoints.push({
                x: random(-half_size, half_size),
                y: random(-half_size, half_size)
            });
        }
      }

      function startGame() {
        setupCheckpoints();
        setupBarriers(); 
        x = 0;
        y = 0;
        currentCheckpoint = 0;
        startTime = millis();
        elapsedTime = 0;
        is_playing = true;
        document.querySelector("#checkpoint-count").innerHTML = `${currentCheckpoint} / ${checkpoints.length}`;
        document.querySelector("#message").innerHTML = "ğŸš€ **ãƒ¬ãƒ¼ã‚¹ä¸­...**";
      }

      function setup() {
        createCanvas(plate_size, plate_size, WEBGL);
        camera(0, 800, 100, 0, 0, 0, 0, 1, 0);
        noStroke();
      }

      function draw() {
        background(0);
        orbitControl(); 

        ambientLight(50, 50, 50);
        directionalLight(100, 20, 20, -1, -1, -1);
        pointLight(20, 20, 100, 0, 0, 800);

        if (is_playing) {
            // æ™‚é–“è¨ˆæ¸¬
            elapsedTime = millis() - startTime;
            document.querySelector("#gameTime").innerHTML = (elapsedTime / 1000).toFixed(3);

            // ãƒœãƒ¼ãƒ«ã®å‹•ã (å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯)
            x = x + speed * g;
            y = y + speed * b;

            // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«åˆ¶é™
            const half_size = plate_size / 2 - r;
            x = constrain(x, -half_size, half_size);
            y = constrain(y, -half_size, half_size);
            
            // éšœå®³ç‰©ã¨ã®ç°¡å˜ãªè¡çªåˆ¤å®š (æ¸›é€ŸåŠ¹æœ)
            const friction = 0.95; 
            for (let bar of barriers) {
                let dist_sq = (x - bar.x) * (x - bar.x) + (y - bar.y) * (y - bar.y);
                if (dist_sq < (r + 20) * (r + 20)) { 
                    // è¡çªã—ãŸå ´åˆã€ä¸€æ™‚çš„ã«ãƒœãƒ¼ãƒ«ã®ç§»å‹•ã‚’æ¸›é€Ÿã•ã›ã‚‹
                    x = x * friction; 
                    y = y * friction;
                    break;
                }
            }


            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè¡çªåˆ¤å®š
            if (currentCheckpoint < checkpoints.length) {
                let target = checkpoints[currentCheckpoint];
                let dist_sq = (x - target.x) * (x - target.x) + (y - target.y) * (y - target.y);
                if (dist_sq < (r + target_radius) * (r + target_radius)) {
                    // è¡çªï¼æ¬¡ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¸
                    currentCheckpoint++;
                    document.querySelector("#checkpoint-count").innerHTML = `${currentCheckpoint} / ${checkpoints.length}`;
                    
                    if (currentCheckpoint === checkpoints.length) {
                        // å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’é€šéã—ã¦ã‚´ãƒ¼ãƒ«
                        is_playing = false;
                        document.querySelector("#message").innerHTML = `ğŸ‰ **ã‚´ãƒ¼ãƒ«ï¼** ã‚¿ã‚¤ãƒ : **${(elapsedTime / 1000).toFixed(3)}s**<br>ã‚¯ãƒªãƒƒã‚¯ã§ãƒªãƒˆãƒ©ã‚¤ï¼`;
                    } else {
                        document.querySelector("#message").innerHTML = `âœ… ${currentCheckpoint}ãƒã‚¤ãƒ³ãƒˆé€šéï¼æ¬¡ã¸ï¼`;
                    }
                }
            }
        }

        // --- æ¿ã®å‹•ã (å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ) ---
        push();
        rotateX((-PI * b) / 180);
        rotateY((PI * g) / 180);
        translate(0, 0, -50); 
        specularMaterial(50, 50, 150);
        box(plate_size, plate_size, 30);
        pop();

        // --- ãƒœãƒ¼ãƒ«ã®å‹•ã (å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ) ---
        push();
        let z_offset = -x * sin((PI * g) / 180) - y * sin((PI * b) / 180);
        translate(x, y, z_offset + r / 2); 
        specularMaterial(200, 200, 50);
        sphere(r);
        pop();

        // --- éšœå®³ç‰©ã®æç”» (æ¿ã¨ä¸€ç·’ã«å›è»¢) ---
        // â˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸâ˜…
        for (let bar of barriers) {
            push();
            // æ¿ã¨ä¸€ç·’ã«å›è»¢ã•ã›ã‚‹
            rotateX((-PI * b) / 180); 
            rotateY((PI * g) / 180);  
            // translateã®Zåº§æ¨™ã‚’æŸ±ã®åŠåˆ†ã®é«˜ã•(40)ã«è¨­å®šã—ã€Z=0ã®æ¿ã‹ã‚‰å‚ç›´ã«ç«‹ã¤ã‚ˆã†ã«ã™ã‚‹
            translate(bar.x, bar.y, 40); 
            specularMaterial(150, 150, 150); 
            cylinder(20, 80); // åŠå¾„20ã€é«˜ã•80
            // å‰å›ã‚ã£ãŸ rotateX(PI / 2); ã¯å‰Šé™¤ã—ã€å††æŸ±ãŒå‚ç›´ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚‹
            pop();
        }

        // --- ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®æç”» (æ¿ã¨ä¸€ç·’ã«å›è»¢) ---
        if (is_playing || currentCheckpoint === checkpoints.length) {
            // é€šéã—ãŸãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’æç”»
            for (let i = 0; i < currentCheckpoint; i++) {
                let cp = checkpoints[i];
                push();
                rotateX((-PI * b) / 180); 
                rotateY((PI * g) / 180);  
                translate(cp.x, cp.y, 15); 
                specularMaterial(50, 255, 50); 
                rotateX(PI / 2);
                cylinder(target_radius / 2, 30);
                pop();
            }

            // ç¾åœ¨ç›®æŒ‡ã™ã¹ããƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’æç”»
            if (currentCheckpoint < checkpoints.length) {
                let target = checkpoints[currentCheckpoint];
                push();
                rotateX((-PI * b) / 180); 
                rotateY((PI * g) / 180);  
                translate(target.x, target.y, 15); 
                specularMaterial(255, 50, 50); 
                rotateX(PI / 2);
                cylinder(target_radius, 30);
                pop();
            }
        }
      }

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒªãƒˆãƒ©ã‚¤
      function mouseClicked() {
        if (!is_playing && socket.connected) {
          startGame();
        }
      }
    </script>
  </body>
</html>